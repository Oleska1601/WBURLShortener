# Shortener — сервис сокращения URL с аналитикой

## Задание
Почти все видели короткие ссылки вроде bit.ly/abc123. Они удобны: их легко пересылать в сообщениях, хорошо смотрятся и позволяют собирать аналитику. Такой подход используют маркетологи, блогеры, продуктовые команды и просто разработчики, которым нужно дать пользователю короткий и понятный адрес.

В этом задании вы реализуете свой собственный мини-сервис сокращения ссылок. Он будет уметь генерировать короткие адреса, перенаправлять пользователей на оригинальные URL и собирать статистику по переходам: кто перешёл, когда и с какого устройства.

Требования
Сервис должен поддерживать:

встроенные HTTP-методы:
– POST /shorten — создание новой сокращённой ссылки;
– GET /s/{short_url} — переход по короткой ссылке;
– GET /analytics/{short_url} — получение аналитики (число переходов, User-Agent, время переходов).

аналитику переходов:
– сохранение информации о переходах в БД;
– возможность агрегации по дням, месяцам, User-Agent.

Дополнительно (будет плюсом):

реализовать кэширование популярных ссылок через Redis;

поддержка кастомных (пользовательских) имен сокращённых ссылок;

простой UI (на любых технологиях — можно даже на HTML + JS без фреймворков) с формой для создания ссылки и просмотром аналитики по ссылкам. Это поможет протестировать сервис без ручных curl-запросов и наглядно увидеть, как он работает.

### Хранение в базе данных

1. Таблица с ссылками
```sql
CREATE TABLE urls (
    id SERIAL PRIMARY KEY,
    short_url VARCHAR(6) UNIQUE NOT NULL,
    original_url VARCHAR(255) NOT NULL,
    created_at TIMESTAMPZ NOT NULL DEFAULT NOW()
);
```

2. Таблица для сбора аналитики
```sql
CREATE TABLE IF NOT EXISTS analytics (
    id SERIAL PRIMARY KEY,
    short_url VARCHAR(7) NOT NULL REFERENCES urls(short_url) ON DELETE CASCADE, 
    requested_at TIMESTAMPZ NOT NULL DEFAULT NOW(),
    user_agent VARCHAR(255) NOT NULL,
    IP VARCHAR(255) NOT NULL,
);
```


### Логика создания сокращенной ссылки (POST /shorten)
1. Пользователь вводит ссылку и кастомную имя сокращенной ссылки (опционально)
```go
type CreateShortURLRequest struct {
	URL      string `json:"url" binding:"required"`
	ShortURL string `json:"short_url"`
}
```
2. Введенные параметры проходят валидацию (в т.ч. и для безопасности и ограничения возможности поддерживать работу с сомнительными ссылками):
- `URL` обязательно должно иметь Host и начинаться с http/https
- `ShortURL` (при наличии) должно быть длиной 6, состоять из заглавных/прописных латинских букв и цифр и не быть зарезервированным системой (например static, тк это используется для отображения UI)
3. При успешной валидации и налиичии `ShortURL` система проверяет, не существует ли такое имя уже для другой ссылки (в случае обнаружения - `http.StatusConflict` с примечанием already exists)
4. При отсутствии `ShortURL` система сгенерирует свою, сохранит и отдаст пользователю

### Логика перехода по сокращенной ссылке (GET /s/{short_url})
1. В пути запроса пользователь вводит `short_url`
2. Система пытается получить значение `original_url`
3. В случае отсутствия пользователь получит ответ со статусом `http.StatusNotFound`
4. В случае успешного обнаружения - статус `http.StatusFound` и redirect
- во время выполнения этого запроса также сохранятся данные пользователя для последующей аналитики и агрегации

### Логика получения аналитики по сокращенной ссылке GET /analytics/{short_url}
1. В пути запроса пользователь вводит `short_url`
2. Система собирает аналитику (или получает актуальное значение из кеша, если пользователь уже ее запрашивал и при этом не переходил еще раз по сокращенной ссылке)
3. Пользователь получает ответ в формате
```go
type GetAnalyticsResponse struct {
	ShortURL       string         `json:"short_url"`
	TotalCount     int            `json:"total_count"`
	DayCount       map[string]int `json:"day_count"`
	MonthCount     map[string]int `json:"month_count"`
	UserAgentCount map[string]int `json:"user_agent_count"`
}
```

### Использованные технологии
- Gin
- PostgreSQL
- Redis
- Goose
- Viper
- Zerolog

### Запуск программы
1. Установка переменных окружения
```
POSTGRES_USER=
POSTGRES_PASSWORD=
POSTGRES_DB=
```
2. Запуск программы
```
make up
```
### Локальное тестирование
1. Swagger
```
http://localhost:8082/swagger/index.html
```
2. UI
```
http://localhost:8082/static/
```
